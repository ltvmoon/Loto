events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # Cấu hình Cache cho file MP3 và Ảnh (Lưu 30 ngày)
    map $sent_http_content_type $expires {
        default                    off;
        text/html                  epoch;
        text/css                   max;
        application/javascript     max;
        ~image/                    max;
        audio/mpeg                 max;
    }

    server {
        listen 80; # Đây là port 80 TRONG CONTAINER, không phải máy chủ thật
        server_name localhost;

        expires $expires;

        # 1. Phục vụ file tĩnh trực tiếp (Nhanh hơn qua Rust)
        location / {
            root /app/static;
            index index.html;
            try_files $uri $uri/ @backend;
        }

        # 2. Chuyển tiếp WebSocket (Rất quan trọng cho Loto)
        location /ws {
            proxy_pass http://loto-backend:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
            proxy_read_timeout 86400; # Giữ kết nối lâu không bị ngắt
        }

        # 3. Chuyển tiếp API
        location @backend {
            proxy_pass http://loto-backend:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api {
            proxy_pass http://loto-backend:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}