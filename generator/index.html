<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>H·ªá Th·ªëng In V√© Loto - BEMOON Style</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        body {
            background: #555;
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        /* CONTROL PANEL */
        .control-panel {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            justify-content: center;
            padding: 20px;
            background: #444;
            border-bottom: 2px solid #fff;
        }

        .btn {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid #000;
            border-radius: 8px;
            box-shadow: 0 4px 0 #000;
            text-transform: uppercase;
            text-decoration: none;
            display: inline-block;
        }

        .btn-print { background: #ffeb3b; color: #000; }
        .btn-png { background: #2196F3; color: white; }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #000; }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            margin-top: 20px;
        }

        /* TICKET CONTAINER */
        .loto-ticket {
            width: 500px;
            background: #fff;
            border: 3px solid #000;
            padding: 10px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .ticket-header {
            text-align: center;
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 5px;
            font-family: "Arial Black", Arial, sans-serif;
            text-transform: uppercase;
        }

        /* TABLE STYLES */
        .loto-section {
            width: 100%;
            border-collapse: collapse;
            border: 3px solid #000;
            table-layout: fixed;
        }

        .loto-section td {
            border: 2px solid #000;
            height: 70px;
            text-align: center;
            vertical-align: middle;
            padding: 0;
            line-height: 1;
            font-family: "Impact", "Arial Narrow", sans-serif;
            font-size: 45px;
            color: #000;
            overflow: hidden;
            /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông c·ªôt */
            width: 50px;
        }

        /* D·∫¢I PH√ÇN C√ÅCH TR·∫ÆNG */
        .separator {
            height: 15px; /* Chi·ªÅu cao t·ªïng c·ªßa d·∫£i ph√¢n c√°ch */
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            /* Border tr√°i ph·∫£i gi·∫£ l·∫≠p ƒë·ªÉ n·ªëi li·ªÅn khung */
            border-left: 3px solid #000;
            border-right: 3px solid #000;
            margin-top: -1px; /* K√©o l√™n ƒë·ªÉ ƒë√® l√™n border b·∫£ng tr√™n */
            margin-bottom: -1px; /* K√©o xu·ªëng ƒë·ªÉ ƒë√® border b·∫£ng d∆∞·ªõi */
            z-index: 10;
        }

        .brand-text {
            font-family: "Black Arial", sans-serif;
            font-size: 10px;
            font-weight: bold;
            color: #000000; /* M√†u ch·ªØ x√°m nh·∫°t cho tinh t·∫ø */
            text-transform: uppercase;
            letter-spacing: 3px;
            background: #fff;
            padding: 0 10px;
        }

        .ticket-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            font-family: Arial, sans-serif;
        }

        .ticket-id {
            background: #000;
            color: #fff;
            padding: 2px 10px;
            border-radius: 4px;
        }

        /* LOADING OVERLAY */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            color: white;
            z-index: 9999;
            text-align: center;
            padding-top: 20%;
            font-size: 24px;
            font-weight: bold;
            font-family: Arial, sans-serif;
        }

        /* PRINT MODE */
        @media print {
            body { background: #fff; padding: 0; }
            .control-panel { display: none !important; }
            .container { display: block; margin-top: 0; }
            .loto-ticket {
                box-shadow: none;
                margin: 0 auto 20px auto;
                border: 3px solid #000;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        ƒêANG X·ª¨ L√ù ·∫¢NH... VUI L√íNG CH·ªú<br>
        <span id="progress-text" style="font-size: 18px; color: #ffeb3b;">ƒêang chu·∫©n b·ªã...</span>
    </div>

    <div class="control-panel no-print">
        <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è IN RA GI·∫§Y / PDF</button>
        <button class="btn btn-png" onclick="downloadAllImages()">üíæ T·∫¢I ·∫¢NH PNG (ZIP)</button>
    </div>

    <div class="container" id="print-area"></div>

    <script src="data.js"></script>

    <script>
        const printArea = document.getElementById('print-area');

        // H√†m helper ƒë·ªÉ t·∫°o HTML cho 1 ph·∫ßn (section) g·ªìm 3 d√≤ng
        function createTableSection(rows, themeColor) {
            let html = '<table class="loto-section">';
            rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                    const style = cell === null ? `style="background-color: ${themeColor} !important; -webkit-print-color-adjust: exact;"` : '';
                    html += `<td ${style}>${cell || ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            return html;
        }

        // H√†m render v√©
        function renderTicket(ticket) {
            const card = document.createElement('div');
            card.className = 'loto-ticket';
            card.setAttribute('data-id', ticket.id);

            const themeColor = ticket.color || "#FFEB3B";

            // Chia 9 d√≤ng th√†nh 3 ph·∫ßn: [0-2], [3-5], [6-8]
            const part1 = ticket.rows.slice(0, 3);
            const part2 = ticket.rows.slice(3, 6);
            const part3 = ticket.rows.slice(6, 9);

            // D·∫£i ph√¢n c√°ch
            const separatorHtml = `
                <div class="separator">
                    <span class="brand-text"><span style="color: gold;">‚òÖ</span>MADE by BEMOON<span style="color: gold;">‚òÖ</span> </span>
                </div>
            `;

            card.innerHTML = `
                <div class="ticket-header" style="color: ${themeColor}">L√î T√î XU√ÇN</div>

                ${createTableSection(part1, themeColor)}

                ${separatorHtml}

                ${createTableSection(part2, themeColor)}

                ${separatorHtml}

                ${createTableSection(part3, themeColor)}

                <div class="ticket-footer" style="color: ${themeColor}">
                    <span>Made by Bemoon</span>
                    <span class="ticket-id">ID: ${ticket.id}</span>
                </div>
            `;
            printArea.appendChild(card);
        }

        // Ch·∫°y l·ªánh render
        if (typeof ticketData !== 'undefined') {
            ticketData.forEach(t => renderTicket(t));
        } else {
            document.body.innerHTML += '<h2 style="color:white; text-align:center; margin-top:50px;">L·ªñI: Kh√¥ng t√¨m th·∫•y file data.js! H√£y ƒë·∫£m b·∫£o file data.js n·∫±m c√πng th∆∞ m·ª•c.</h2>';
        }

        // H√†m t·∫£i ·∫£nh (Gi·ªØ nguy√™n logic c≈©)
        async function downloadAllImages() {
            const tickets = document.querySelectorAll('.loto-ticket');
            if (tickets.length === 0) {
                alert("Kh√¥ng c√≥ v√© n√†o ƒë·ªÉ t·∫£i!");
                return;
            }

            const loading = document.getElementById('loading-overlay');
            const progress = document.getElementById('progress-text');
            loading.style.display = 'block';

            const zip = new JSZip();

            await new Promise(r => setTimeout(r, 100));

            for (let i = 0; i < tickets.length; i++) {
                const ticket = tickets[i];
                const id = ticket.getAttribute('data-id') || `ve_${i+1}`;
                progress.innerText = `ƒêang ch·ª•p v√© ID: ${id} (${i+1}/${tickets.length})`;

                try {
                    const canvas = await html2canvas(ticket, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: "#ffffff",
                        logging: false
                    });
                    const imgData = canvas.toDataURL("image/png").split(',')[1];
                    zip.file(`ticket-${id}.png`, imgData, {base64: true});
                } catch (e) {
                    console.error("L·ªói khi ch·ª•p v√© " + id, e);
                }
            }

            progress.innerText = "ƒêang n√©n file ZIP... Vui l√≤ng ch·ªù!";
            zip.generateAsync({type:"blob"}).then(function(content) {
                saveAs(content, "Danh_Sach_Ve_Loto_Bemoon.zip");
                loading.style.display = 'none';
            });
        }
    </script>
</body>
</html>